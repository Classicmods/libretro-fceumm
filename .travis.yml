sudo: required

language: minimal

env:
  global:
    - IMAGE=registry.gitlab.com/bleemsync-dev/docker-autodevops-buildenvs/mmc-crosscompiler-docker-image:latest_internal
    - TARGETBUILD=fceumm_libretro
    - REPO_URL=https://github.com/${TRAVIS_REPO_SLUG}

services:
  - docker

before_script:
  - bash -c "echo ${REPO_URL}"
  - docker login -u ${GITLAB_USER} -p ${GITLAB_PASS} registry.gitlab.com
  - docker pull ${IMAGE}
  - docker run -it -d --name crosscomp ${IMAGE} bash
  - docker exec -it crosscomp bash -c "git clone --depth=50 --branch=master https://github.com/${TRAVIS_REPO_SLUG} ${TRAVIS_REPO_SLUG}"
  - docker exec -it crosscomp bash -c "cd ${TRAVIS_REPO_SLUG} && classic_make_nesc Makefile clean"
  - docker exec -it crosscomp bash -c "cd ${TRAVIS_REPO_SLUG} && classic_make_nesc Makefile"
  - docker exec -it crosscomp bash -c "chown 600 ~/.keys/release_private_key.pem"
  - docker exec -it crosscomp bash -c "cd ${TRAVIS_REPO_SLUG} && echo -e  'cd /var/www/html/cores/Automated_Builds/NESC\nput ${TARGETBUILD}.so' | sftp -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -i ~/.keys/release_private_key.pem docker@classicmodscloud.com"